# Implementation Plan: Commercial Listing Fields (feat_1085)

## Overview

Add support for commercial listing fields to track number of units and estimated revenue for commercial properties.

**New Fields:**

- `units` (Integer): Number of units available in the commercial property
- `revenue` (Long): Estimated revenue generated by the commercial property (stored as cents/smallest currency unit)

---

## Phase 1: Database Layer

### 1.1 Create Database Migration

**File:** `modules/koki-server/src/main/resources/db/migration/common/V1_56__listing_commercial_fields.sql`

**Tasks:**

- Add `units` column (INT, nullable)
- Add `revenue` column (BIGINT, nullable)

**SQL:**

```sql
ALTER TABLE T_LISTING
    ADD COLUMN units INT;
ALTER TABLE T_LISTING
    ADD COLUMN revenue BIGINT;
```

---

## Phase 2: Domain Layer (koki-server)

### 2.1 Update ListingEntity

**File:** `modules/koki-server/src/main/kotlin/com/wutsi/koki/listing/server/domain/ListingEntity.kt`

**Tasks:**

- Add `units: Int?` property
- Add `revenue: Long?` property (stored as smallest currency unit)
- Place fields logically with other commercial-related properties

### 2.2 Update ListingMapper

**File:** `modules/koki-server/src/main/kotlin/com/wutsi/koki/listing/server/mapper/ListingMapper.kt`

**Tasks:**

- Update `toListing()` method to map `units` and `revenue` fields
- Convert `revenue` from Long to Money object using `toMoney()` helper
- Update `toListingSummary()` method to include `units` and `revenue` if needed in summary

### 2.3 Update ListingService

**File:** `modules/koki-server/src/main/kotlin/com/wutsi/koki/listing/server/service/ListingService.kt`

**Tasks:**

- Update `create()` method to handle `units` and `revenue` from CreateListingRequest
- Update `update()` method to handle `units` and `revenue` from UpdateListingRequest
- Ensure proper currency conversion when storing revenue

---

## Phase 3: DTO Layer (koki-dto) ✅ COMPLETED

### 3.1 Update Listing DTO ✅

**File:** `modules/koki-dto/src/main/kotlin/com/wutsi/koki/listing/dto/Listing.kt`

**Tasks:**

- ✅ Add `units: Int?` field
- ✅ Add `revenue: Money?` field (using Money object for proper currency handling)
- ✅ Add fields in logical location with other property details

### 3.2 Update ListingSummary DTO ✅

**File:** `modules/koki-dto/src/main/kotlin/com/wutsi/koki/listing/dto/ListingSummary.kt`

**Tasks:**

- ✅ Add `units: Int?` field (useful for listing cards/previews)
- ✅ Add `revenue: Money?` field (useful for listing cards/previews)

### 3.3 Update CreateListingRequest ✅

**File:** `modules/koki-dto/src/main/kotlin/com/wutsi/koki/listing/dto/CreateListingRequest.kt`

**Tasks:**

- ✅ Add `units: Int?` field with optional validation (@Min(1) if non-null)
- ✅ Add `revenue: Long?` field (stored as cents)
- ✅ No @NotNull validation (optional fields for commercial properties only)

### 3.4 Update UpdateListingRequest ✅

**File:** `modules/koki-dto/src/main/kotlin/com/wutsi/koki/listing/dto/UpdateListingRequest.kt`

**Tasks:**

- ✅ Add `units: Int?` field
- ✅ Add `revenue: Long?` field (stored as cents)

---

## Phase 4: Portal Layer (koki-portal)

### 4.1 Update ListingModel

**File:** `modules/koki-portal/src/main/kotlin/com/wutsi/koki/portal/listing/model/ListingModel.kt`

**Tasks:**

- Add `units: Int?` property
- Add `revenue: MoneyModel?` property for display formatting

### 4.2 Update ListingForm

**File:** `modules/koki-portal/src/main/kotlin/com/wutsi/koki/portal/listing/form/ListingForm.kt`

**Tasks:**

- Add `units: Int?` property
- Add `revenue: Long?` property (form stores as cents)

### 4.3 Update ListingMapper (Portal)

**File:** `modules/koki-portal/src/main/kotlin/com/wutsi/koki/portal/listing/mapper/ListingMapper.kt`

**Tasks:**

- Update `toListingModel()` to map `units` and `revenue` fields from Listing DTO
- Update `toListingForm()` to map `units` and `revenue` fields from Listing DTO
- Update form-to-request mapping methods to include new fields

### 4.4 Update ListingService (Portal)

**File:** `modules/koki-portal/src/main/kotlin/com/wutsi/koki/portal/listing/service/ListingService.kt`

**Tasks:**

- Ensure `create()` and `update()` methods pass through `units` and `revenue` fields
- Handle any form validation or business logic specific to commercial properties

### 4.5 Update UI Templates (if applicable)

**Location:** Portal view templates for listing create/edit forms

**Tasks:**

- Add form fields for `units` (numeric input)
- Add form fields for `revenue` (money input with currency)
- Fields should be visible/required only for commercial listing types
- Add display of units and revenue in listing detail views
- Add display in listing cards/summary views if appropriate

---

## Phase 5: Testing

### 5.1 Unit Tests ✅ COMPLETED

**Files updated:**

- ✅ `modules/koki-server/src/test/kotlin/com/wutsi/koki/listing/server/endpoint/CreateListingEndpointTest.kt`
- ✅ `modules/koki-server/src/test/kotlin/com/wutsi/koki/listing/server/endpoint/UpdateListingEndpointTest.kt`

**Tasks:**

- ✅ Add test cases for creating listings with units and revenue
- ✅ Add test cases for updating listings with units and revenue
- ✅ Verify proper Money conversion for revenue field
- ✅ Test null handling (fields are optional)

### 5.2 Integration Tests

**Tasks:**

- Test end-to-end flow: create commercial listing → verify storage → retrieve → verify fields
- Test filtering/searching by units and revenue (if applicable)
- Test data migration on existing listings (should handle null values)

### 5.3 Manual Testing Checklist

- [ ] Run database migration successfully
- [ ] Create new commercial listing with units and revenue
- [ ] Update existing listing with units and revenue
- [ ] Verify fields display correctly in UI
- [ ] Verify fields are saved and retrieved correctly
- [ ] Verify null values handled properly for non-commercial listings
- [ ] Verify currency formatting for revenue field
- [ ] Test with different currencies
- [ ] Verify search/filter functionality (if implemented)

---

## Phase 6: Documentation

### 6.1 API Documentation

**Tasks:**

- Update API docs to include new fields in request/response schemas
- Document that these fields are optional and primarily for commercial listings
- Provide examples with commercial property data

### 6.2 User Documentation

**Tasks:**

- Update user guide with information about commercial listing fields
- Explain when to use units and revenue fields
- Provide examples of typical values

---

## Phase 7: Deployment

### 7.1 Pre-Deployment Checklist

- [ ] All unit tests passing
- [ ] Integration tests passing
- [ ] Code review completed
- [ ] Database migration tested on staging
- [ ] UI changes reviewed

### 7.2 Deployment Steps

1. Deploy database migration (V1_56__listing_commercial_fields.sql)
2. Deploy koki-server with updated domain/service layer
3. Deploy koki-dto with updated DTOs
4. Deploy koki-portal with updated UI
5. Monitor logs for any errors
6. Verify functionality in production

### 7.3 Rollback Plan

- If issues occur, migration can be rolled back with:
  ```sql
  ALTER TABLE T_LISTING DROP COLUMN units;
  ALTER TABLE T_LISTING DROP COLUMN revenue;
  ```
- Revert application code to previous version

---

## Files to Modify

### Database

1. `modules/koki-server/src/main/resources/db/migration/common/V1_56__listing_commercial_fields.sql` (NEW)

### koki-server

2. `modules/koki-server/src/main/kotlin/com/wutsi/koki/listing/server/domain/ListingEntity.kt`
3. `modules/koki-server/src/main/kotlin/com/wutsi/koki/listing/server/mapper/ListingMapper.kt`
4. `modules/koki-server/src/main/kotlin/com/wutsi/koki/listing/server/service/ListingService.kt`

### koki-dto

5. `modules/koki-dto/src/main/kotlin/com/wutsi/koki/listing/dto/Listing.kt`
6. `modules/koki-dto/src/main/kotlin/com/wutsi/koki/listing/dto/ListingSummary.kt`
7. `modules/koki-dto/src/main/kotlin/com/wutsi/koki/listing/dto/CreateListingRequest.kt`
8. `modules/koki-dto/src/main/kotlin/com/wutsi/koki/listing/dto/UpdateListingRequest.kt`

### koki-portal

9. `modules/koki-portal/src/main/kotlin/com/wutsi/koki/portal/listing/model/ListingModel.kt`
10. `modules/koki-portal/src/main/kotlin/com/wutsi/koki/portal/listing/form/ListingForm.kt`
11. `modules/koki-portal/src/main/kotlin/com/wutsi/koki/portal/listing/mapper/ListingMapper.kt`
12. `modules/koki-portal/src/main/kotlin/com/wutsi/koki/portal/listing/service/ListingService.kt`

### Tests

13. `modules/koki-server/src/test/kotlin/com/wutsi/koki/listing/server/endpoint/CreateListingEndpointTest.kt`
14. `modules/koki-server/src/test/kotlin/com/wutsi/koki/listing/server/endpoint/UpdateListingEndpointTest.kt`
15. Additional test files as needed

### UI Templates (if applicable)

16. Listing create/edit form templates
17. Listing detail view templates
18. Listing card/summary templates

---

## Estimated Effort

- **Phase 1 (Database):** 0.5 hours
- **Phase 2 (Domain Layer):** 1 hour
- **Phase 3 (DTO Layer):** 1 hour
- **Phase 4 (Portal Layer):** 2-3 hours (depends on UI complexity)
- **Phase 5 (Testing):** 2 hours
- **Phase 6 (Documentation):** 1 hour
- **Phase 7 (Deployment):** 0.5 hours

**Total Estimated Time:** 8-9 hours

---

## Dependencies

- No external dependencies required
- Fields are optional, so no breaking changes to existing API contracts
- Backward compatible with existing listings (null values)

---

## Risk Assessment

**Low Risk:**

- Adding nullable fields to database (no data loss risk)
- Optional fields in DTOs (backward compatible)
- No changes to existing business logic

**Potential Issues:**

- Ensure currency handling is consistent across all layers
- UI conditional display logic needs to be clear
- Consider whether filtering/sorting by these fields is needed

---

## Future Enhancements

- Add validation rules (e.g., units > 0 for commercial properties)
- Add search/filter capabilities by units and revenue range
- Add analytics/reporting on commercial properties
- Consider cap rate calculations (revenue / price)
- Add unit types (residential, office, retail, etc.)

