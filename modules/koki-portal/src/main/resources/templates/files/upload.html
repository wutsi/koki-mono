<!DOCTYPE HTML>
<html th:lang="${page.language}" xmlns:th="https://www.thymeleaf.org">
<head>
    <div th:replace="~{__components/layout :: head}"></div>
</head>

<body>
<div th:replace="~{__components/layout :: navbar}"></div>

<div class="container">
    <div class="row">
        <div class="col-12 col-md-8 offset-md-2">
            <div class="widget">
                <div class="widget-body">
                    <h1>Upload Files</h1>
                    <div class="text-center">
                        <button class="btn-upload btn btn-primary margin-top" onclick="start_upload()">
                            Upload File
                        </button>
                        <input id="file-upload" multiple style="display:none"
                               th:data-upload-url="${uploadUrl}"
                               type="file"/>
                    </div>
                    <div>
                        Select the files to upload.<br/>
                        Max size: 10Mb
                    </div>

                    <div class="progress">
                        <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" class="progress-bar"
                             role="progressbar"></div>
                    </div>
                    <div id="file-container"></div>
                </div>
            </div>
            <div class="widget" th:if="${returnUrl}">
                <div class="widget-body">
                    <a class="btn btn-secondary" th:href="${returnUrl}">Close</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let fileId = 0;

    function start_upload() {
        document.getElementById("file-upload").click();
    }

    async function upload_file(file, uploadUrl) {
        const containerDiv = document.getElementById("file-container");
        const data = new FormData();
        data.append('file', file);

        // Show File
        ++fileId;
        const re = /(?:\.([^.]+))?$/;
        const ext = re.exec(file.name)[1];
        containerDiv.innerHTML = containerDiv.innerHTML +
            "<DIV id='file-" + fileId + "' class='padding-small margin-top border'>" +
            "  <SPAN class='fiv-viv fiv-icon-" + ext + "'></SPAN>&nbsp;" +
            "  <SPAN>" + file.name + "</SPAN>&nbsp;" +
            "  <SPAN class='status'>Uploading... </SPAN>" +
            "</DIV>"

        const response = await fetch(uploadUrl, {
            method: 'POST',
            body: data
        });

        const statusDiv = containerDiv.querySelector("#file-" + fileId + " .status")
        if (response.ok || response.status === 0) {
            console.log("SUCCESS - Uploading " + file.name + " to " + uploadUrl);
            statusDiv.innerHTML = "<i class='fa-solid fa-check fa-xl success'></i>"
        } else {
            console.log("ERROR - Uploading " + file.name + " to " + uploadUrl, response.statusText);
            statusDiv.innerHTML = "<i class='fa-solid fa-xmark fa-xl error'></i>"
        }
    }

    function update_progress(now, max) {
        const progressDiv = document.querySelector(".progress .progress-bar");
        let percent = 100 * now / max;
        progressDiv.setAttribute("aria-valuemax", max);
        progressDiv.setAttribute("aria-valuenow", now);
        progressDiv.style.width = percent + "%";
    }

    document.getElementById("file-upload").addEventListener('change', async () => {
        const fileDiv = document.getElementById("file-upload");
        const uploadUrl = fileDiv.getAttribute("data-upload-url");
        console.log('upload-url', uploadUrl);

        for (i = 0; i < fileDiv.files.length; i++) {
            const file = fileDiv.files[i];
            await upload_file(file, uploadUrl);
            update_progress(i + 1, fileDiv.files.length);
        }
    });

</script>
</body>


</html>
